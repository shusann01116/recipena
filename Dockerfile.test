# Test-optimized Dockerfile for faster CI builds
FROM rust:1@sha256:25038aa450210c53cf05dbf7b256e1df1ee650a58bb46cbc7d6fa79c1d98d083 AS builder

WORKDIR /app
COPY . /app

# Build in test mode with faster compilation
RUN cargo build --tests --release

FROM eclipse-temurin:17-jre AS downloader

RUN apt-get update && apt-get install -y \
    wget \
    && rm -rf /var/lib/apt/lists/*

RUN wget -O /tabula.jar https://github.com/tabulapdf/tabula-java/releases/download/v1.0.5/tabula-1.0.5-jar-with-dependencies.jar

FROM rust:1@sha256:25038aa450210c53cf05dbf7b256e1df1ee650a58bb46cbc7d6fa79c1d98d083

# Install Java for tabula
RUN apt-get update && apt-get install -y \
    openjdk-17-jre \
    bash \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/target/release/recipena /recipena
COPY --from=builder /app/target/release/deps/* /usr/local/bin/
COPY --from=downloader /tabula.jar /tabula.jar

# Copy source code for testing
COPY --from=builder /app /app
WORKDIR /app

ENV DOCKER_ENV=true
ENV CI=true

# No entrypoint for testing - allows direct command execution